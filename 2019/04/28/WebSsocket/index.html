<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>WebSocket | 冰璃</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">WebSocket</h1><a id="logo" href="/.">冰璃</a><p class="description">雪肤红眸，素发如瀑</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">WebSocket</h1><div class="post-meta">Apr 28, 2019<span> | </span><span class="category"><a href="/categories/前端/">前端</a></span></div><div class="post-content"><p><strong>WebSsocket和Ajax</strong><br>打个比方，时不时要去服务器查看一下有没有新的留言。</p>
<p><strong>用ajax</strong><br>只能搞个定时器，时不时去请求一下看看有没有新的留言，也就是轮询。这种方式缺点是<br>1.浪费服务器资源，因为要不停的连接，断开，请求。<br>2.浪费带宽资源，如果是移动端的应用，流量是要钱的，更死人了。<br>所以ajax不适合现在移动互联网的需求。</p>
<p><strong>用websocket</strong></p>
<ol>
<li>性能高，比普通ajax大概高2-10倍左右<br>普通的http通信是基于字符的通信，所谓超文本，还是文本。而websocket一开始是文本，但一旦连接建立了，协议升级完成了，会是一个二进制的一个协议，无需对数据做什么转换之类的，这是性能高的原因之一。</li>
<li>双向通信<br>不需要你去请求，只要连上了等着就行，等有数据了服务器会主动找你。这是websocket最大的优点。还是基于http，在建立连接的阶段，还是通过普通的http协议来交换信息。</li>
<li>直接跨域</li>
</ol>
<hr>
<h3 id="socket-io"><a href="#socket-io" class="headerlink" title="socket.io"></a>socket.io</h3><p>cnpm i socket.io -D</p>
<ol>
<li>简单方便</li>
<li>兼容1e5</li>
<li>自动帮助你对数据进行解析</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  //html</span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;script src=&apos;http://localhost:8080/socket.io/socket.io.js&apos;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      let sock = io.connect(&apos;ws://localhost:8081/&apos;); </span><br><span class="line"></span><br><span class="line">    //   sock.emit(&apos;aaa&apos;,12,&apos;socket成功&apos;)</span><br><span class="line">      sock.on(&apos;aaa&apos;,function(a,b)&#123;</span><br><span class="line">          console.log(a,b)</span><br><span class="line">      &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">//js</span><br><span class="line">const http = require(&apos;http&apos;);</span><br><span class="line">const io = require(&apos;socket.io&apos;);</span><br><span class="line"></span><br><span class="line">//1. 建立普通http</span><br><span class="line">let server = http.createServer((req,res)=&gt;&#123;</span><br><span class="line">  </span><br><span class="line">&#125;)</span><br><span class="line">server.listen(8081);</span><br><span class="line"></span><br><span class="line">//2. 建立ws</span><br><span class="line"> let wsServer = io.listen(server); //监听http服务，如果发现是找ws的，它就会接手，把连接抢过来，它来负责做下面的交互。</span><br><span class="line"> //当建立连接了</span><br><span class="line"> wsServer.on(&apos;connection&apos;,sock=&gt;&#123;</span><br><span class="line">     //发送数据</span><br><span class="line">   sock.emit(&apos;aaa&apos;,12,&apos;哈哈&apos;);</span><br><span class="line">     //接收数据           </span><br><span class="line">//   sock.on(&apos;aaa&apos;,function(a,b)&#123;</span><br><span class="line">//       console.log(a,b);</span><br><span class="line">//   &#125;)</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="原生websocket"><a href="#原生websocket" class="headerlink" title="原生websocket"></a>原生websocket</h3><p>network里websocket请求头里会有这几个东西<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//一个扩展信息，可忽略</span><br><span class="line">Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits</span><br><span class="line">// 验证是不是websocket</span><br><span class="line">Sec-WebSocket-Key: ydOb9ivgNMpZk0zNiobpfQ==</span><br><span class="line">// websocket版本,不同版本验证是有差异的</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">//协议升级</span><br><span class="line">Upgrade: websocket</span><br></pre></td></tr></table></figure></p>
<p>连接建立阶段实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"> //html</span><br><span class="line">   &lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      let ws = new WebSocket(&apos;ws://localhost:8081/&apos;);</span><br><span class="line">      </span><br><span class="line">      //并不是连接上就会触发，交换数据后会触发</span><br><span class="line">      ws.onopen=function()&#123;</span><br><span class="line">          console.log(&apos;连接已建立&apos;); </span><br><span class="line">      &#125;;</span><br><span class="line">      //当有消息</span><br><span class="line">      ws.onmessage=function()&#123;&#125;;</span><br><span class="line">      //当连接关闭</span><br><span class="line">      ws.onclose=function()&#123;&#125;;</span><br><span class="line">      //当异常关闭</span><br><span class="line">      ws.onerror=function()&#123;&#125;;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// js</span><br><span class="line">  </span><br><span class="line">//二进制，实际上websocket就是tcp连接，所以需要net</span><br><span class="line">const net = require(&apos;net&apos;);</span><br><span class="line">const crypto = require(&apos;crypto&apos;);</span><br><span class="line"></span><br><span class="line">function parseHeader(str)&#123;</span><br><span class="line">    let arr = str.split(&apos;\r\n&apos;).filter(line=&gt;line);</span><br><span class="line">    arr.shift();</span><br><span class="line"></span><br><span class="line">    let headers=&#123;&#125;</span><br><span class="line">    arr.forEach(line =&gt; &#123;</span><br><span class="line">       let [name,value]=line.split(&apos;:&apos;);</span><br><span class="line">       name=name.replace(/^\s+|\s+$/g,&apos;&apos;).toLowerCase();</span><br><span class="line">       value=value.replace(/^\s+|\s+$/g,&apos;&apos;);</span><br><span class="line"></span><br><span class="line">       headers[name]=value;</span><br><span class="line">    &#125;);</span><br><span class="line">    return headers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> //参数是一个原始的sock对象</span><br><span class="line">let server = net.createServer(sock=&gt;&#123;</span><br><span class="line">    //第一次握手接到的数据</span><br><span class="line">   sock.once(&apos;data&apos;,buffer=&gt;&#123;</span><br><span class="line">    let str = buffer.toString();</span><br><span class="line">    let headers=parseHeader(str);</span><br><span class="line"></span><br><span class="line">    if(headers[&apos;upgrade&apos;]!=&apos;websocket&apos;)&#123;</span><br><span class="line">        console.log(&apos;no upgrade&apos;);</span><br><span class="line">        sock.end();</span><br><span class="line">    &#125;else if(headers[&apos;sec-websocket-version&apos;]!=&apos;13&apos;)&#123;</span><br><span class="line">        console.log(&apos;no 13&apos;);</span><br><span class="line">        sock.end();</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        //1.key : 从http的头里来</span><br><span class="line">        //2.uuid : &apos;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&apos; //作者定的，固定的。 </span><br><span class="line">        //3.result =&gt; base64(sha1(key + uuid))</span><br><span class="line">        let key =  headers[&apos;sec-websocket-key&apos;];</span><br><span class="line">        let uuid = &apos;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&apos;;</span><br><span class="line">         //创建一个hash对象，签名算法是sha1</span><br><span class="line">        let hash = crypto.createHash(&apos;sha1&apos;);</span><br><span class="line">        hash.update(key + uuid);</span><br><span class="line">        let key2 = hash.digest(&apos;base64&apos;);</span><br><span class="line"></span><br><span class="line">        sock.write(`HTTP/1.1 101 Switching Protocols\r\nUpgrade:websocket\r\nConnection:upgrade\r\nSec-Websocket-Accept:$&#123;key2&#125;\r\n\r\n`);</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   sock.on(&apos;end&apos;,()=&gt;&#123;</span><br><span class="line">   </span><br><span class="line">   &#125;)</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(8081);</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/js/">js</a></div><div class="post-nav"><a class="pre" href="/2019/05/05/mac安装mysql/">mac安装mysql</a><a class="next" href="/2019/04/22/正则表达式/">正则表达式</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'a41b62a0fd6bbf0e4420',
  clientSecret: '967058332166270e103b22da8f361fff4a9cedf9',
  repo: 'xiaohuolu.github.io',
  owner: 'xiaohuolu',
  admin: ['xiaohuolu'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/后台/">后台</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/项目管理/">项目管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/h5/" style="font-size: 15px;">h5</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/utils/" style="font-size: 15px;">utils</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/09/28/项目管理/">git</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/14/webpack/">webpack</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/17/nest/">nest</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/23/服务端渲染/">服务端渲染</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/17/koa/">koa</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/15/express/">express</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/07/node操作mysql/">node操作mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/05/mac安装mysql/">mac安装mysql</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/28/WebSsocket/">WebSocket</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/22/正则表达式/">正则表达式</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">冰璃.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>